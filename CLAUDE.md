# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Ghidrathon-based MCP (Model Context Protocol) Bridge that runs inside Ghidra to provide AI systems with programmatic access to Ghidra's reverse engineering capabilities. The bridge exposes a lightweight HTTP JSON API for automated binary analysis and code understanding workflows.

## Architecture

### Core Components

- **`ghidra_mcp_server.py`**: Main HTTP server that runs inside Ghidra via Ghidrathon. Provides ThreadingHTTPServer and executes scripts via `script.runScript()`.

- **`test_script.py`**: Reference implementation for Ghidra API access. Demonstrates the script execution pattern with parameter passing and result return via temp files.

- **`mcp_apis/`**: Reserved for future modular API handlers (currently contains only `__init__.py`).

### Key Design Patterns

**Script Execution Pattern**: Instead of caching Ghidra context objects, the bridge uses `script.runScript()` to execute scripts that have direct access to Ghidra's Flat API (currentProgram, currentAddress, etc.).

**Result Communication**: Scripts receive a temp file path as the first argument and write JSON results to that file. The server reads and returns the result after script execution completes.

**Synchronous Execution**: `runScript()` is synchronous - it blocks until the script completes, making result retrieval straightforward.

## Development Commands

### Running the Bridge
```bash
# Inside Ghidra CodeBrowser: Execute ghidra_mcp_server.py via Ghidrathon
# Server auto-starts and logs: "Listening on http://HOST:PORT"

# Headless mode:
analyzeHeadless <projDir> <projName> -import <binary> -scriptPath . -postScript ghidra_mcp_server.py

# Environment variables:
# GHIDRA_MCP_HOST (default: 127.0.0.1)
# GHIDRA_MCP_PORT (default: 8803)
```

### API Testing
```bash
# Run test script (demonstrates script execution pattern)
curl http://127.0.0.1:8803/api/run/test_script
```

## Code Conventions

**Language**: Python 3 with Ghidrathon runtime
**Indentation**: 4 spaces
**Type Hints**: Used where practical

**API Endpoints**:
- `GET /api/run/test_script` - Execute test script and return results

**Script Parameter Convention**:
- `args[0]`: Result output file path (temp file generated by server)
- `args[1:]`: Additional parameters passed to the script

**Error Handling**: Minimal logging to avoid Ghidra console noise, but preserve error context in API responses

## Adding New API Endpoints

To add a new API endpoint:

1. Create a new script file (e.g., `my_script.py`) following `test_script.py` pattern
2. Use `getScriptArgs()` to receive parameters
3. Write JSON result to the file path in `args[0]`
4. Add a route in `ghidra_mcp_server.py` that calls `_cached_script.runScript("my_script.py", args)`

## Security Configuration

**Default binding**: `127.0.0.1:8803` (localhost only)
**Authentication**: None (designed for local AI agent access)
**Threading**: Daemon threads only to preserve Ghidra GUI responsiveness
**Dependencies**: Minimal footprint using only Ghidra stdlib plus standard Python libraries

## Troubleshooting

If encountering issues:
1. Check that program is loaded in Ghidra before starting server
2. Verify `_cached_script` is successfully cached in startup logs
3. Check temp file permissions if script results are not returned
4. Ensure script files are in Ghidra's script path

The bridge handles both GUI and headless modes with appropriate threading models for each environment.
