# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Ghidrathon-based MCP (Model Context Protocol) Bridge that runs inside Ghidra to provide AI systems with programmatic access to Ghidra's reverse engineering capabilities. The bridge exposes a lightweight HTTP JSON API for automated binary analysis and code understanding workflows.

## Architecture

### Core Components

- **`ghidra_mcp_server.py`**: Main HTTP server that runs inside Ghidra via Ghidrathon. Provides ThreadingHTTPServer and executes scripts via `script.runScript()`.

- **`api/`**: API 脚本目录，包含所有可调用的 API 实现：
  - **`demo.py`**: API 开发参考样例，展示参数接收、Ghidra API 访问、结果返回的完整模式
  - **`basic_info.py`**: 获取当前程序基础信息（名称、架构、内存布局等）

- **`api_v1/`**: v1 版本 API 模块目录

### Key Design Patterns

**Script Execution Pattern**: Instead of caching Ghidra context objects, the bridge uses `script.runScript()` to execute scripts that have direct access to Ghidra's Flat API (currentProgram, currentAddress, etc.).

**Result Communication**: Scripts receive a temp file path as the first argument and write JSON results to that file. The server reads and returns the result after script execution completes.

**Synchronous Execution**: `runScript()` is synchronous - it blocks until the script completes, making result retrieval straightforward.

## Development Commands

### Running the Bridge
```bash
# Inside Ghidra CodeBrowser: Execute ghidra_mcp_server.py via Ghidrathon
# Server auto-starts and logs: "Listening on http://HOST:PORT"

# Headless mode:
analyzeHeadless <projDir> <projName> -import <binary> -scriptPath . -postScript ghidra_mcp_server.py

# Environment variables:
# GHIDRA_MCP_HOST (default: 127.0.0.1)
# GHIDRA_MCP_PORT (default: 8803)
```

### API Testing
```bash
# 运行演示脚本（API 开发参考样例）
curl http://127.0.0.1:8803/api/demo

# 获取程序基础信息
curl http://127.0.0.1:8803/api/basic_info
```

## Code Conventions

**Language**: Python 3 with Ghidrathon runtime
**Indentation**: 4 spaces
**Type Hints**: Used where practical

**API Endpoints**:
- `GET /api/demo` - 执行演示脚本，用于测试和 API 开发参考
- `GET /api/basic_info` - 获取当前程序的基础信息
- `GET /api/v1/search?q=<query>` - 搜索函数和字符串

**Script Parameter Convention**:
- `args[0]`: Result output file path (temp file generated by server)
- `args[1:]`: Additional parameters passed to the script

**Error Handling**: Minimal logging to avoid Ghidra console noise, but preserve error context in API responses

## Adding New API Endpoints

To add a new API endpoint:

1. 复制 `api/demo.py` 作为新 API 的模板
2. 在新脚本中实现业务逻辑，使用 `getScriptArgs()` 接收参数
3. 将 JSON 结果写入 `args[0]` 指定的文件路径
4. 在 `ghidra_mcp_server.py` 中添加路由处理函数和路由规则

**参考样例**: `api/demo.py` 包含完整的 API 开发模式说明和测试代码
**实际 API 示例**: `api/basic_info.py` 展示了一个简洁的生产级 API 实现

## Security Configuration

**Default binding**: `127.0.0.1:8803` (localhost only)
**Authentication**: None (designed for local AI agent access)
**Threading**: Daemon threads only to preserve Ghidra GUI responsiveness
**Dependencies**: Minimal footprint using only Ghidra stdlib plus standard Python libraries

## Troubleshooting

If encountering issues:
1. Check that program is loaded in Ghidra before starting server
2. Verify `_cached_script` is successfully cached in startup logs
3. Check temp file permissions if script results are not returned
4. Ensure script files are in Ghidra's script path

The bridge handles both GUI and headless modes with appropriate threading models for each environment.
